name: Biblioteca DevOps

on:
  push:
    branches: [ main, develop ]
  pull_request:

jobs:

  # ---------------------------
  # JOB 1: Análisis de calidad
  # ---------------------------
  quality:
    name: Calidad de Código
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black isort flake8 mypy

      - name: Run quality checks
        run: |
          black --check app tests
          isort --check-only app tests
          flake8 app tests
          mypy app --ignore-missing-imports

  # ---------------------------
  # JOB 2: Tests unitarios
  # ---------------------------
  tests:
    name: Pruebas Unitarias + Cobertura
    needs: quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov uvicorn

      - name: Run tests with coverage
        run: |
          pytest tests/unit tests/api tests/ui --cov=app --cov-fail-under=80 --cov-report=xml

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml

  # ---------------------------
  # JOB 3: Pruebas API REST
  # ---------------------------
  api_tests:
    name: Pruebas de API (Postman + Newman)
    needs: tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install uvicorn

      - name: Start FastAPI
        run: |
          uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          sleep 5

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Newman
        run: npm install -g newman

      - name: Run Postman collection
        run: newman run postman/biblioteca.postman_collection.json

  # ---------------------------
  # JOB 4: Pruebas de rendimiento (JMeter)
  # ---------------------------
  performance:
    name: Pruebas de Rendimiento (JMeter)
    needs: api_tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install uvicorn

      - name: Start FastAPI
        run: |
          uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          sleep 5

      - name: Install JMeter
        run: |
          sudo apt-get update
          sudo apt-get install -y jmeter

      - name: Run JMeter test
        run: |
          mkdir -p jmeter/report
          jmeter -n -t jmeter/api_books.jmx -l jmeter/results.jtl -e -o jmeter/report

      - name: Upload JMeter report
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-report
          path: jmeter/report

  # ---------------------------
  # JOB 5: Construcción de artefactos
  # ---------------------------
  artifacts:
    name: Construcción y Versionado de Artefactos
    needs: performance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install builder
        run: pip install build

      - name: Build wheel
        run: python -m build

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: wheel-artifact
          path: dist/*.whl

      - name: Create ZIP
        run: |
          git archive --format zip --output biblioteca-devops_${{ github.run_number }}.zip HEAD

      - name: Upload ZIP
        uses: actions/upload-artifact@v4
        with:
          name: biblioteca-devops-zip
          path: biblioteca-devops_*.zip


  # ---------------------------
  # JOB 6: Pruebas funcionales (Selenium)
  # ---------------------------
  selenium_tests:
    name: Pruebas Funcionales (Selenium)
    needs: artifacts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install app + Selenium dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install selenium webdriver-manager pytest

      - name: Start FastAPI server
        run: |
          uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          sleep 5

      - name: Run Selenium tests
        env:
          PYTEST_ADDOPTS: ""
        run: |
          pytest -o addopts="" tests/functional --maxfail=1 --disable-warnings -q  

  # ---------------------------
  # JOB 7: Deploy simulado
  # ---------------------------
  deploy:
    name: Simulación de Despliegue
    needs: selenium_tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install app dependencies
        run: |
          pip install fastapi uvicorn

      - name: Start application (deploy simulation)
        run: |
          uvicorn app.main:app --host 0.0.0.0 --port 9000 &
          sleep 5

      - name: Smoke test
        run: |
          curl -I http://127.0.0.1:9000/api/health
